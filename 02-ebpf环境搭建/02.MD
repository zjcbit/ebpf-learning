
# 虚拟机安装
``` shell
git clone --recurse-submodules https://github.com/lizrice/learning-ebpf
cd learning-ebpf
limactl start learning-ebpf.yaml
limactl shell learning-ebpf

# You'll need to be root for most of the examples
sudo -s
```
- 内核版本低于5.0时, 需要下载btf文件, 不同版本btf 下载
``` shell
https://code.alibaba-inc.com/chengshuyi.csy/vmlinux-btf/blob/master/vmlinux-btf/vmlinux-4.19.91-007.ali4000.alios7.x86_64
```
- 如果内核版本高于5.0, 可以使用如下命令生成btf文件
``` shell
bpftool btf dump file /sys/kernel/btf/vmlinux format c > vmlinux.h
```
bcc 中有很多可用的例子, 可以参考
``` shell
git clone --recurse-submodules  https://github.com/iovisor/bcc.git
cd bcc/libbpf-tools/
make
```
- 课程链接： https://time.geekbang.org/column/article/484207?screen=full
- 使用bpftrace 跟踪进程创建
``` shell
sudo bpftrace -e 'tracepoint:syscalls:sys_enter_execve,tracepoint:syscalls:sys_enter_execveat { printf("%-6d %-8s", pid, comm); join(args->argv);}'
```
可以简单的查进程的创建，但是无法查看进程的父子关系，无法查看进程的cgroup信息，无法查看进程的启动时间等信息。可以使用bpftrace的内置函数curtask来获取进程的父子关系，cgroup信息，启动时间等信息。如下：

``` shell bpfstrace.sh
#!/usr/bin/bpftrace

#include <linux/sched.h>

BEGIN
{
    printf("%-9s %-6s %-6s  %-6s %-16s %s\n", "TIME", "PID", "CGROUP", "PPID", "COMM", "ARGS")
}

tracepoint:syscalls:sys_enter_execve,
tracepoint:syscalls:sys_enter_execveat
{
    $task = (struct task_struct *)curtask;

    time("%H:%M:%S  ");
    printf("%-6d %-16d %-6d %-16s ", pid, cgroup, $task->parent->tgid, comm);
    join(args->argv);
}
```
- 运行
``` shell
#bpftrace bpfstrace.sh
Attaching 3 probes...
TIME      PID    CGROUP  PPID   COMM             ARGS
14:19:00  57051  1       2107   staragentd
14:19:00  57052  1       57051  su               bash -c run.sh
```


